<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cash Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4 text-center">Cash Manager</h2>

    <form id="entryForm" class="row g-3">
      <div class="col-md-2">
        <input type="date" id="date" class="form-control" required />
      </div>
      <div class="col-md-2">
        <input
          type="text"
          id="head"
          class="form-control"
          list="headOptions"
          placeholder="Head"
          required
        />
        <datalist id="headOptions"></datalist>
      </div>
      <div class="col-md-2">
        <input
          type="number"
          step="0.01"
          id="cashIn"
          class="form-control"
          placeholder="Cash In"
        />
      </div>
      <div class="col-md-2">
        <input
          type="number"
          step="0.01"
          id="cashOut"
          class="form-control"
          placeholder="Cash Out"
        />
      </div>
      <div class="col-md-2">
        <select id="transactionType" class="form-select" required>
          <option value="" disabled selected>Select Type</option>
          <option value="Cash">Cash</option>
          <option value="Credit">Credit</option>
          <option value="Debit">Debit</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="text" id="notes" class="form-control" placeholder="Notes" />
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Add Entry</button>
      </div>
    </form>

    <div class="mt-4">
      <h5>Current Balance: ₹<span id="balance">0.00</span></h5>
    </div>

    <table class="table table-bordered table-striped mt-3">
      <thead class="table-dark">
        <tr>
          <th>Date</th>
          <th>Head</th>
          <th>Cash In</th>
          <th>Cash Out</th>
          <th>Balance</th>
          <th>Transaction Type</th>
          <th>Notes</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Entries will be loaded here -->
      </tbody>
    </table>
  </div>

  <script>
    let currentBalance = 0;

    async function fetchHeads() {
      try {
        const res = await fetch('/heads');
        const heads = await res.json();
        const datalist = document.getElementById('headOptions');
        datalist.innerHTML = '';
        heads.forEach((head) => {
          const option = document.createElement('option');
          option.value = head;
          datalist.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to fetch heads', error);
      }
    }

    async function fetchEntries() {
      try {
        const res = await fetch('/entries');
        const entries = await res.json();

        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

        currentBalance = 0;

        entries.forEach((entry) => {
          currentBalance = parseFloat(entry.balance);

          const row = document.createElement('tr');
          row.dataset.id = entry.id;
          row.dataset.cashIn = entry.cashIn;
          row.dataset.cashOut = entry.cashOut;

          row.innerHTML = `
            <td>${entry.date}</td>
            <td>${entry.head}</td>
            <td>₹${parseFloat(entry.cashIn).toFixed(2)}</td>
            <td>₹${parseFloat(entry.cashOut).toFixed(2)}</td>
            <td>₹${parseFloat(entry.balance).toFixed(2)}</td>
            <td>${entry.transactionType}</td>
            <td>${entry.notes || ''}</td>
            <td><button class="btn btn-danger btn-sm deleteBtn">Delete</button></td>
          `;
          tableBody.appendChild(row);
        });

        document.getElementById('balance').innerText = currentBalance.toFixed(2);
      } catch (error) {
        console.error('Failed to fetch entries', error);
      }
    }

    async function addEntry(entryData) {
      try {
        const res = await fetch('/add-entry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(entryData),
        });
        const result = await res.json();
        if (res.ok) {
          await fetchEntries();
          await fetchHeads();
          return true;
        } else {
          alert(result.message || 'Failed to add entry');
          return false;
        }
      } catch (error) {
        console.error('Failed to add entry', error);
        alert('Failed to add entry');
        return false;
      }
    }

    async function deleteEntry(id) {
      try {
        const res = await fetch(`/delete-entry/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (res.ok) {
          await fetchEntries();
        } else {
          alert(result.message || 'Failed to delete entry');
        }
      } catch (error) {
        console.error('Failed to delete entry', error);
        alert('Failed to delete entry');
      }
    }

    document.getElementById('entryForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const date = document.getElementById('date').value;
      const head = document.getElementById('head').value.trim();
      const cashIn = parseFloat(document.getElementById('cashIn').value) || 0;
      const cashOut = parseFloat(document.getElementById('cashOut').value) || 0;
      const transactionType = document.getElementById('transactionType').value;
      const notes = document.getElementById('notes').value.trim();

      if (!date || !head || !transactionType) {
        alert('Please fill in all required fields');
        return;
      }

      const entryData = { date, head, cashIn, cashOut, transactionType, notes };

      const success = await addEntry(entryData);
      if (success) {
        this.reset();
      }
    });

    document.getElementById('tableBody').addEventListener('click', function (e) {
      if (e.target.classList.contains('deleteBtn')) {
        const row = e.target.closest('tr');
        const id = row.dataset.id;
        if (confirm('Are you sure you want to delete this entry?')) {
          deleteEntry(id);
        }
      }
    });

    // Initial load
    fetchHeads();
    fetchEntries();
  </script>
  <script src="/app.js"></script>
</body>
</html>
